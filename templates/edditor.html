<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
    <meta name="format-detection" content="telephone=no">
    <meta name="format-detection" content="email=no">
    <meta name="format-detection" content="address=no">
    <meta name="mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <meta name="theme-color" content="#20223A">
    <title>拼图预览</title>
    <link rel="stylesheet" href="{{ url_for('static', filename='css/style.css') }}">
    <link rel="stylesheet" href="{{ url_for('static', filename='css/mobile.css') }}">
    <style>
        .preview-main { max-width: 900px; margin: 40px auto; display: flex; gap: 32px; flex-wrap: wrap; }
        .preview-left, .preview-right { flex: 1; min-width: 320px; }
        .preview-card { background: #20223A; border-radius: 8px; box-shadow: 0 2px 10px rgba(0,0,0,0.3); padding: 24px; margin-bottom: 24px; }
        .preview-upload-box { border: 2px dashed #E5E7EB; border-radius: 8px; padding: 40px; text-align: center; cursor: pointer; }
        .preview-img { width: 100%; border-radius: 8px; display: block; margin-bottom: 12px; }
        .preview-grid-canvas { position: absolute; top: 0; left: 0; width: 100%; height: 100%; pointer-events: none; }
        .preview-img-box { position: relative; width: 100%; min-height: 240px; background: #20223A; border-radius: 8px; display: flex; align-items: center; justify-content: center; }
        .preview-btn-row { text-align: center; margin-top: 24px; }
     /* 新增选项样式 */
        .random-options {
            display: flex;
            flex-wrap: wrap;
            gap: 16px;
            margin-top: 16px;
            padding-top: 16px;
            border-top: 1px solid #2d3250;
        }
        .random-option-item {
            display: flex;
            align-items: center;
            gap: 8px;
        }
        .random-option-item input[type="checkbox"] {
            width: 16px;
            height: 16px;
            accent-color: #165DFF;
        }
        .random-option-item label {
            font-size: 14px;
            color: #E5E7EB;
            cursor: pointer;
        }
        .share-code {
            margin-top: 25px;
            font-size: 18px;
            font-weight: bold;
        }
    </style>
    
</head>
<body>
{% include '_navbar.html' %}

<div class="background-blur"></div>

    <div class="page-title" style="margin-top: 20px;">
        <button class="btn btn-secondary back-btn" onclick="window.location.href='{{ url_for('main') }}'" style="padding: 8px 16px; font-size: 12px; margin-right: 16px;">
            <span class="chinese-text">返回</span>
        </button>
        <span class="chinese-text" style="color: #F9E078; font-size: 18px;">创建拼图</span>
    </div>
    <div class="preview-main">
        <!-- 左侧：上传和配置 -->
        <div class="preview-left">
            <div class="preview-card">
                <h3 style="font-size: 16px; margin-bottom: 16px;">上传图片</h3>
                <div class="preview-upload-box" id="uploadBox">
                    <span style="font-size: 32px; color: #165DFF; margin-bottom: 12px;">📁</span>
                    <p style="font-size: 14px; color: #666;">
                        <div>点击或拖拽图片上传</div>
                        <div><span class="number-text">（JPG/PNG，</span>最大<span class="number-text">5MB）</span></div>
                    </p>
                    <input type="file" id="imageUpload" accept="image/*" style="display:none;">
                </div>
                <!-- 选择系统图片 / 管理员新增系统关卡 -->
                <div class="preview-btn-row" style="margin-top: 12px; display:flex; gap:12px; justify-content:center; flex-wrap:wrap;">
                    <button id="pickSystemImageBtn" class="btn btn-secondary" type="button" onclick="openSystemImagePicker()">选择系统图片</button>
                </div>
                <!-- 管理员创建系统关卡的表单项（仅管理员显示提交按钮，但字段对所有人可见也不影响） -->
                <div class="input-item">
                    <label>关卡标题</label>
                    <input id="adminTitleInput" type="text" placeholder="请输入关卡标题（4-20个字符）" maxlength="20">
                </div>
                <div class="input-item">
                    <label>类型</label>
                    <select id="typeSelect">
                        <option value="nature">自然风光</option>
                        <option value="animal">动物</option>
                        <option value="building">建筑</option>
                        <option value="cartoon">卡通</option>
                        <option value="other" selected>其他</option>
                    </select>
                </div>
            </div>
            <div class="preview-card">
                <h3 style="font-size: 16px; margin-bottom: 16px;">拼图配置</h3>
                <div class="input-item">
                    <label>拼图块数</label>
                    <select id="difficultySelect">
                        <option value="3">3 x 3</option>
                        <option value="4" selected>4 x 4</option>
                        <option value="5">5 x 5</option>
                        <option value="6">6 x 6</option>
                        <option value="8">8 x 8</option>
                    </select>
                </div>
                <div class="input-item">
                    <label>形状</label>
                    <select id="shapeSelect">
                        <option value="square" selected>方形</option>
                        <option value="triangle">三角形</option>
                          <option value="jigsaw">拼图块</option>
                    </select>
                </div>
                <!-- 新增的随机选项 -->
                <div class="random-options">
                    <div class="random-option-item">
                        <input type="checkbox" id="randomRotation" checked>
                        <label for="randomRotation">随机旋转</label>
                    </div>
                    <div class="random-option-item">
                        <input type="checkbox" id="randomFlip" checked>
                        <label for="randomFlip">随机翻转</label>
                    </div>
                </div>
            </div>
        </div>
        <!-- 右侧：预览区 -->
        <div class="preview-right">
            <div class="preview-card">
                <h3 style="font-size: 16px; margin-bottom: 16px;">拼图预览</h3>
                <div class="preview-img-box" id="previewImgBox">
                    <img id="previewImage" class="preview-img" src="" alt="预览图" style="display:none;">
                    <canvas id="gridCanvas" class="preview-grid-canvas" style="display:none;"></canvas>
                    <p id="previewTip" style="color:#666;">上传图片并选择块数后预览效果</p>
                </div>
                <div style="margin-top: 16px; text-align: right;">
                    <p style="font-size: 14px; color: #666;">预计难度：<span id="difficultyText">简单</span></p>
                </div>
                <div class="preview-btn-row" style="display:flex; flex-direction:column; gap:12px; align-items:center;">
                    <button id="createPuzzleBtn" class="btn btn-primary" disabled>创建拼图</button>
                    <button id="adminAddSystemBtn" class="btn btn-primary" type="button" style="display:none;">新增系统关卡</button>

                     
                </div>
            </div>
        </div>
    </div>
<!-- 在现有模态框后面添加分享模态框 -->
<div class="modal-mask" id="shareModal" style="display: none;">
    <div class="modal-content" style="max-width: 400px;">
        <div class="modal-header">
            <span>保存到分享</span>
            <span class="modal-close" onclick="document.getElementById('shareModal').style.display='none'">×</span>
        </div>
        <div class="modal-body">
            <div class="input-item">
                <label for="puzzleTitle">关卡名称</label>
                <input type="text" id="puzzleTitle" placeholder="请输入关卡名称（5-20个字符）">
                <p id="titleError" style="color: #ff4d4f; font-size: 12px; margin-top: 4px; display: none;">
                    关卡名称长度需在5~20个字符之间
                </p>
            </div>
        </div>
        <div class="modal-footer">
            <button class="btn btn-secondary" onclick="document.getElementById('shareModal').style.display='none'">取消</button>
            <button class="btn btn-primary" id="confirmShareBtn">确认分享</button>
        </div>
    </div>
</div>
    <script>
        // 根据接口文档：优先 /auth/is_admin，失败退回 /auth/me，再兜底 userId===1
        async function fetchIsAdmin() {
            const token = localStorage.getItem('puzzleToken');
            if (!token) return false;
            try {
                // 首选 /auth/is_admin
                let r = await fetch('/auth/is_admin', { headers: { Authorization: `Bearer ${token}` } });
                if (r && r.ok) {
                    const j = await r.json();
                    return !!(j && (j.code === 200 || j.code === '200') && j.data && j.data.isAdmin === true);
                }
                // 备选 /auth/me
                r = await fetch('/auth/me', { headers: { Authorization: `Bearer ${token}` } });
                if (r && r.ok) {
                    const j = await r.json();
                    return !!(j && (j.code === 200 || j.code === '200') && j.data && j.data.isAdmin === true);
                }
            } catch (_) {}
            // UI 兜底（不影响后端权限校验）
            return localStorage.getItem('puzzleUserId') === '1';
        }

        async function initEditorAdminUi() {
            const isAdmin = await fetchIsAdmin();
            const adminBtn = document.getElementById('adminAddSystemBtn');
            if (adminBtn) {
                if (isAdmin) {
                    adminBtn.style.setProperty('display', 'inline-flex', 'important');
                } else {
                    adminBtn.style.setProperty('display', 'none', 'important');
                }
            }

            const pickBtn = document.getElementById('pickSystemImageBtn');
            if (pickBtn) {
                // 捕获阶段绑定，避免被其他脚本拦截
                pickBtn.removeEventListener('click', openSystemImagePicker, true);
                pickBtn.addEventListener('click', openSystemImagePicker, { capture: true });
            }

            if (adminBtn) {
                adminBtn.addEventListener('click', submitAdminSystemLevel);
            }
        }

        // 增加重试，避免刷新瞬间因鉴权/时序导致按钮未显示
        async function initEditorAdminUiWithRetry(maxTry = 20, delayMs = 500) {
            for (let i = 0; i < maxTry; i++) {
                await initEditorAdminUi();
                const btn = document.getElementById('adminAddSystemBtn');
                if (btn && btn.style.display !== 'none') return;
                await new Promise(r => setTimeout(r, delayMs));
            }
        }

        // 打开系统图片选择器：调用 /pic/levels/system
        async function openSystemImagePicker() {
            console.log('openSystemImagePicker called');
            try {
                const r = await fetch('/pic/levels/system');
                const j = await r.json();
                if (!(j && j.code === 200)) throw new Error('加载系统图片失败');
                const list = Array.isArray(j.data) ? j.data : [];
                ensureSystemImageModal();
                const modal = document.getElementById('systemImageModal');
                const grid = document.getElementById('systemImageGrid');
                if (!list.length) {
                    grid.innerHTML = '<div style="color:#B8BCC8; text-align:center; grid-column:1/-1;">暂无系统图片</div>';
                    modal.style.display = 'flex';
                    return;
                }
                grid.innerHTML = list.map(item => `
                    <div class="card" style="background:#20223A; padding:8px; cursor:pointer;">
                        <img src="${item.image_url}" alt="${item.title||''}" style="width:100%; height:100px; object-fit:cover; border-radius:4px;">
                        <div style="font-size:12px; color:#E5E7EB; margin-top:6px; white-space:nowrap; overflow:hidden; text-overflow:ellipsis;">${item.title||''}</div>
                    </div>
                `).join('');
                modal.style.display = 'flex';
                grid.querySelectorAll('div.card').forEach((card, idx) => {
                    card.addEventListener('click', () => {
                        const chosen = list[idx];
                        if (chosen && chosen.image_url) {
                            imgData = chosen.image_url;
                            previewImage.src = imgData;
                            previewImage.style.display = 'block';
                            gridCanvas.style.display = 'block';
                            previewTip.style.display = 'none';
                            drawGrid();
                            createPuzzleBtn.disabled = false;
                        }
                        modal.style.display = 'none';
                    });
                });
            } catch (e) {
                alert('加载系统图片失败，请稍后重试');
            }
        }

        function ensureSystemImageModal() {
            if (document.getElementById('systemImageModal')) return;
            const wrap = document.createElement('div');
            wrap.id = 'systemImageModal';
            wrap.style.cssText = 'position:fixed; inset:0; background:rgba(0,0,0,0.55); display:none; align-items:center; justify-content:center; z-index:2000;';
            wrap.innerHTML = `
                <div style="width:90%; max-width:720px; background:#20223A; border:1px solid #333; box-shadow:0 10px 30px rgba(0,0,0,0.5); padding:16px; border-radius:8px;">
                    <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:12px;">
                        <div style="color:#F9E078; font-size:16px;">选择系统图片</div>
                        <button id="systemImageClose" class="btn btn-secondary" type="button">关闭</button>
                    </div>
                    <div id="systemImageGrid" style="display:grid; grid-template-columns: repeat(auto-fill, minmax(140px, 1fr)); gap:12px;"></div>
                </div>`;
            document.body.appendChild(wrap);
            document.getElementById('systemImageClose').addEventListener('click', () => {
                wrap.style.display = 'none';
            });
        }

        // 管理员提交系统关卡
        async function submitAdminSystemLevel() {
            try {
                const token = localStorage.getItem('puzzleToken');
                if (!token) { alert('请先登录'); return; }
                const title = (document.getElementById('adminTitleInput').value||'').trim();
                const type = document.getElementById('typeSelect').value;
                const pieceCount = parseInt(difficultySelect.value, 10);
                // 形状映射：square->rect, triangle->triangle, jigsaw->irregular
                const shapeMap = { square: 'rect', triangle: 'triangle', jigsaw: 'irregular' };
                const pieceShape = shapeMap[shapeSelect.value] || 'rect';
                const isRotatable = document.getElementById('randomRotation').checked ? 1 : 0;
                const isFlipable = document.getElementById('randomFlip').checked ? 1 : 0;

                if (!title || title.length < 4 || title.length > 20) {
                    alert('关卡标题长度需在4~20个字符之间');
                    return;
                }
                if (!imgData) {
                    alert('请先选择或上传图片');
                    return;
                }

                // 将预览图片转为 Blob（若是本地上传得到的dataURL；若是系统图片URL，则直接拉取并转为Blob）
                let imageBlob;
                if (imgData.startsWith('data:')) {
                    const res = await fetch(imgData);
                    imageBlob = await res.blob();
                } else {
                    const res = await fetch(imgData, { mode: 'cors' });
                    imageBlob = await res.blob();
                }

                const form = new FormData();
                form.append('title', title);
                form.append('image', imageBlob, 'system-level.png');
                form.append('difficulty', pieceCount <= 4 ? 'easy' : (pieceCount <= 6 ? 'medium' : 'hard'));
                form.append('piece_count', String(pieceCount));
                form.append('piece_shape', pieceShape);
                form.append('is_rotatable', String(isRotatable));
                form.append('is_flipable', String(isFlipable));
                form.append('is_system_level', '1');
                form.append('type', type);

                const r = await fetch('/pic/puzzles', {
                    method: 'POST',
                    headers: { Authorization: `Bearer ${token}` },
                    body: form
                });
                const j = await r.json();
                if (j && (j.code === 200 || j.code === '200')) {
                    alert('系统关卡创建成功');
                    // 刷新系统图片数据源，便于“选择系统图片”立刻看到新图
                    await prefetchSystemImages();
                    // 写入新关卡ID，便于后续保存进度
                    if (j.data && j.data.puzzle_id) {
                        localStorage.setItem('puzzleId', String(j.data.puzzle_id));
                        localStorage.setItem('isSystemLevel', 'true');
                    }
                } else {
                    alert(j?.message || '创建失败');
                }
            } catch (e) {
                alert('提交失败，请稍后重试');
            }
        }

        // 预拉系统图片数据，供“选择系统图片”立即使用
        let cachedSystemImages = [];
        async function prefetchSystemImages() {
            try {
                const r = await fetch('/pic/levels/system');
                const j = await r.json();
                if (j && j.code === 200) cachedSystemImages = j.data || [];
            } catch(e) {}
        }
        const uploadBox = document.getElementById('uploadBox');
        const imageUpload = document.getElementById('imageUpload');
        const previewImage = document.getElementById('previewImage');
        const gridCanvas = document.getElementById('gridCanvas');
        const difficultySelect = document.getElementById('difficultySelect');
        const createPuzzleBtn = document.getElementById('createPuzzleBtn');
        const previewTip = document.getElementById('previewTip');
        const difficultyText = document.getElementById('difficultyText');
        const shapeSelect = document.getElementById('shapeSelect');
        // 获取新增的复选框元素
        const randomRotationCheckbox = document.getElementById('randomRotation');
        const randomFlipCheckbox = document.getElementById('randomFlip');

        let imgData = null;
        let currentShape = 'square';

        uploadBox.onclick = () => imageUpload.click();
        uploadBox.addEventListener('dragover', e => { e.preventDefault(); uploadBox.style.borderColor = "#165DFF"; });
        uploadBox.addEventListener('dragleave', e => { e.preventDefault(); uploadBox.style.borderColor = "#E5E7EB"; });
        uploadBox.addEventListener('drop', function(e) {
            e.preventDefault();
            uploadBox.style.borderColor = "#E5E7EB";
            if (e.dataTransfer.files.length > 0) {
                imageUpload.files = e.dataTransfer.files;
                handleImage();
            }
        });
        imageUpload.addEventListener('change', handleImage);

        function handleImage() {
            if (imageUpload.files.length > 0) {
                const file = imageUpload.files[0];
                if (file.size > 5 * 1024 * 1024) {
                    alert('图片太大，请选择小于5MB的图片');
                    return;
                }
                const reader = new FileReader();
                reader.onload = function(e) {
                    imgData = e.target.result;
                    previewImage.src = imgData;
                    previewImage.style.display = 'block';
                    gridCanvas.style.display = 'block';
                    previewTip.style.display = 'none';
                    drawGrid();

                    createPuzzleBtn.disabled = false;

                    createPuzzleBtn.disabled = false;
                    createPuzzleBtn.disabled = false;

                };
                reader.readAsDataURL(file);
            }
        }

        function updateDifficultyText() {
            const grid = parseInt(difficultySelect.value, 10); // 3/4/5/6/8
            const shape = shapeSelect.value; // square/triangle/jigsaw
            const rot = randomRotationCheckbox.checked;
            const flip = randomFlipCheckbox.checked;

            // 评分规则（可调）：块数权重最高，其次形状，再次旋转/翻转
            let score = 0;
            // 块数（3/4/5/6/8）
            if (grid <= 3) score += 1;       // 9块
            else if (grid === 4) score += 2; // 16块
            else if (grid === 5) score += 3; // 25块
            else if (grid === 6) score += 4; // 36块
            else if (grid >= 8) score += 5;  // 64块

            // 形状：square(方形)最易，triangle 次之，jigsaw(拼图块/不规则)最难
            if (shape === 'triangle') score += 1;
            else if (shape === 'jigsaw') score += 2;

            // 旋转/翻转增加难度
            if (rot) score += 1;
            if (flip) score += 1;

            // 分段映射到文本
            let txt = '简单';
            if (score >= 3 && score <= 4) txt = '中等';
            else if (score >= 5 && score <= 6) txt = '困难';
            else if (score >= 7) txt = '极难';
            difficultyText.textContent = txt;
        }
        difficultySelect.addEventListener('change', () => {
            drawGrid();
            updateDifficultyText();
        });
        updateDifficultyText();

        shapeSelect.addEventListener('change', () => {
            currentShape = shapeSelect.value;
            drawGrid();
            updateDifficultyText();
        });

        // 随机旋转/翻转影响难度
        randomRotationCheckbox.addEventListener('change', updateDifficultyText);
        randomFlipCheckbox.addEventListener('change', updateDifficultyText);

        function drawGrid() {
            if (!imgData) return;
            previewImage.onload = function() {
                gridCanvas.width = previewImage.width;
                gridCanvas.height = previewImage.height;
                gridCanvas.style.width = previewImage.width + 'px';
                gridCanvas.style.height = previewImage.height + 'px';
                const ctx = gridCanvas.getContext('2d');
                ctx.clearRect(0, 0, gridCanvas.width, gridCanvas.height);
                ctx.strokeStyle = "#FFFFFF";
                ctx.lineWidth = 2;
                const grid = parseInt(difficultySelect.value);
                currentShape = shapeSelect.value;
                for (let i = 1; i < grid; i++) {
                    let x = i * gridCanvas.width / grid;
                    ctx.beginPath();
                    ctx.moveTo(x, 0);
                    ctx.lineTo(x, gridCanvas.height);
                    ctx.stroke();
                }
                for (let i = 1; i < grid; i++) {
                    let y = i * gridCanvas.height / grid;
                    ctx.beginPath();
                    ctx.moveTo(0, y);
                    ctx.lineTo(gridCanvas.width, y);
                    ctx.stroke();
                }
                if (currentShape === 'triangle') {
                    for (let i = 0; i < grid; i++) {
                        for (let j = 0; j < grid; j++) {
                            const x = j * gridCanvas.width / grid;
                            const y = i * gridCanvas.height / grid;
                            const nextX = (j + 1) * gridCanvas.width / grid;
                            const nextY = (i + 1) * gridCanvas.height / grid;
                            if ((i % 2 === 0 && j % 2 === 0) || (i % 2 === 1 && j % 2 === 1)) {
                                ctx.beginPath();
                                ctx.moveTo(x, y);
                                ctx.lineTo(nextX, nextY);
                                ctx.stroke();
                            } else {
                                ctx.beginPath();
                                ctx.moveTo(nextX, y);
                                ctx.lineTo(x, nextY);
                                ctx.stroke();
                            }
                        }
                    }
                }
            };
            previewImage.src = imgData;
        }


        createPuzzleBtn.addEventListener('click', onCreatePuzzle);
        // 页面加载完成后初始化管理员按钮（带重试）、并在可见时/鉴权就绪时再重试
        document.addEventListener('DOMContentLoaded', function() {
            initEditorAdminUiWithRetry();
            
            // 恢复之前的设置
            const customImage = localStorage.getItem('customImage');
            const customSize = localStorage.getItem('customSize');
            const customShape = localStorage.getItem('customShape');
            const storedRandomRotation = localStorage.getItem('randomRotation');
            const storedRandomFlip = localStorage.getItem('randomFlip');

            if (customImage && customSize) {
                imgData = customImage;
                previewImage.src = imgData;
                previewImage.style.display = 'block';
                gridCanvas.style.display = 'block';
                previewTip.style.display = 'none';
                difficultySelect.value = customSize;
                if (customShape) { 
                    shapeSelect.value = customShape; 
                    currentShape = customShape; 
                }
                if (storedRandomRotation !== null) {
                    randomRotationCheckbox.checked = storedRandomRotation === 'true';
                }
                if (storedRandomFlip !== null) {
                    randomFlipCheckbox.checked = storedRandomFlip === 'true';
                }
                updateDifficultyText();
                drawGrid();
                createPuzzleBtn.disabled = false;
                localStorage.removeItem('customImage');
                localStorage.removeItem('customSize');
                localStorage.removeItem('customShape');
                localStorage.removeItem('randomRotation');
                localStorage.removeItem('randomFlip');
            }
            
            document.addEventListener('visibilitychange', () => {
                if (!document.hidden) initEditorAdminUiWithRetry();
            });
            window.addEventListener('authready', () => initEditorAdminUiWithRetry());
            window.addEventListener('storage', (e) => {
                if (e.key === 'puzzleToken' && e.newValue) initEditorAdminUiWithRetry();
            });
        });



        // 创建拼图：仅在前端保存到 localStorage，随后弹出“下一步”弹窗
        function onCreatePuzzle(){
            if (!imgData) { alert('请先上传或选择图片'); return; }
            localStorage.setItem('customImage', imgData);
            localStorage.setItem('customSize', difficultySelect.value);
            localStorage.setItem('customShape', shapeSelect.value);
            localStorage.setItem('randomRotation', randomRotationCheckbox.checked);
            localStorage.setItem('randomFlip', randomFlipCheckbox.checked);
            // 自定义关卡若需要保存进度，这里可以先创建关卡，拿到 puzzle_id。
            // 如仅畅玩不存档，可生成一个本地ID，供后续使用（不会写数据库）。
            if (!localStorage.getItem('puzzleId')) {
                const localId = 'custom:' + Date.now();
                localStorage.setItem('puzzleId', localId);
                localStorage.setItem('isSystemLevel', 'false');
            }
            ensureNextStepModal();
            document.getElementById('nextStepModal').style.display = 'flex';
        }

        // 创建完成后的下一步弹窗（开始游戏 / 去分享）
        function ensureNextStepModal(){
            if (document.getElementById('nextStepModal')) return;
            const wrap = document.createElement('div');
            wrap.id = 'nextStepModal';
            wrap.style.cssText = 'position:fixed; inset:0; background:rgba(0,0,0,0.55); display:none; align-items:center; justify-content:center; z-index:2100;';
            wrap.innerHTML = `
                <div style="width:88%; max-width:520px; background:#20223A; border:1px solid #333; box-shadow:0 10px 30px rgba(0,0,0,0.5); padding:20px; border-radius:8px; text-align:center;">
                    <div style="color:#F9E078; font-size:16px; margin-bottom:12px;">拼图已创建</div>
                    <div style="color:#E5E7EB; font-size:13px; margin-bottom:18px;">接下来你想要？</div>
                    <div style="display:flex; gap:12px; justify-content:center; flex-wrap:wrap;">
                        <button id="goPlayBtn" class="btn btn-primary">开始游戏</button>
                        <button id="goShareBtn" class="btn btn-secondary">去分享</button>
                        <button id="closeNextStepBtn" class="btn btn-secondary">关闭</button>
                    </div>
                </div>`;
            document.body.appendChild(wrap);
            document.getElementById('goPlayBtn').addEventListener('click', () => {
                window.location.href = '{{ url_for('game_page') }}';
            });
            document.getElementById('goShareBtn').addEventListener('click', () => {
                wrap.style.display = 'none';
                // 直接开始分享流程，不需要额外的输入框
                handleShareSubmit();
            });
            document.getElementById('closeNextStepBtn').addEventListener('click', () => {
                wrap.style.display = 'none';
            });
        }

        // 分享功能
        function handleShareSuccess(shareData) {
            // 创建分享成功模态框
            const modal = document.createElement('div');
            modal.className = 'modal-mask';
            modal.style.display = 'flex';
            modal.innerHTML = `
                <div class="modal-content" style="max-width: 400px;">
                    <div class="modal-header">
                        <span>分享成功！</span>
                        <span class="modal-close" onclick="this.closest('.modal-mask').remove()">×</span>
                    </div>
                    <div class="modal-body" style="text-align: center;">
                        <p>您的拼图已成功分享</p>
                        <p> </p>
                        <p class="share_code">分享码: <strong>${shareData.share_code}</strong></p>
                        <div style="display: flex; justify-content: center; gap: 15px; margin-top: 20px;">
                            <button id="viewShareBtn" class="btn btn-primary">
                                去查看
                            </button>
                            <button id="continueGameBtn" class="btn btn-secondary">
                                继续游戏
                            </button>
                        </div>
                    </div>
                </div>
            `;
            
            document.body.appendChild(modal);

            document.getElementById('viewShareBtn').addEventListener('click', () => {
                window.location.href = '/share?tab=myShares';
                modal.remove();
            });

            document.getElementById('continueGameBtn').addEventListener('click', () => {
                localStorage.setItem('customImage', imgData);
                localStorage.setItem('customSize', difficultySelect.value);
                localStorage.setItem('customShape', shapeSelect.value);
                localStorage.setItem('randomRotation', randomRotationCheckbox.checked);
                localStorage.setItem('randomFlip', randomFlipCheckbox.checked);
                window.location.href = '{{ url_for('game_page') }}';
                modal.remove();
            });
        }


        // 分享提交处理函数
        async function handleShareSubmit() {
            // 获取关卡标题，优先使用管理员输入框的值
            const adminTitle = document.getElementById('adminTitleInput').value.trim();
            const title = adminTitle || '我的自定义拼图';

            // 验证标题长度
            if (title.length < 5 || title.length > 20) {
                alert('关卡名称长度需在5~20个字符之间');
                return;
            }

            try {
                // 获取用户token
                const token = localStorage.getItem('puzzleToken');
                if (!token) {
                    alert('请先登录才能分享');
                    window.location.href = '/';
                    return;
                }

                // 1. 创建关卡
                const formData = new FormData();
                formData.append('title', title);
                formData.append('difficulty', difficultyText.textContent === '简单' ? 'easy' : difficultyText.textContent === '中等' ? 'medium' : 'hard');
                formData.append('piece_count', difficultySelect.value * difficultySelect.value);
                // 形状映射：square->rect, triangle->triangle, jigsaw->irregular
                const shapeMap = { square: 'rect', triangle: 'triangle', jigsaw: 'irregular' };
                formData.append('piece_shape', shapeMap[shapeSelect.value]);
                formData.append('is_rotatable', randomRotationCheckbox.checked ? 1 : 0);
                formData.append('is_system_level', 0);
                difficultySelect
                // 生成唯一文件名函数
                function generateUniqueFileName() {
                    const timestamp = new Date().getTime();
                    const randomString = Math.random().toString(36).substring(2, 10);
                    return `puzzle_${timestamp}_${randomString}.png`;
                }

                // 将base64图片转换为Blob对象
                const blob = await fetch(imgData).then(res => res.blob());
                const uniqueFileName = generateUniqueFileName();
                formData.append('image', blob, uniqueFileName);

                // 调用创建关卡接口
                const createResponse = await fetch('/pic/puzzles', {
                    method: 'POST',
                    headers: {
                        'Authorization': `Bearer ${token}`
                    },
                    body: formData
                });

                // 处理可能的401未授权错误
                if (createResponse.status === 401) {
                    localStorage.removeItem('puzzleToken');
                    localStorage.removeItem('userId');
                    alert('登录已过期，请重新登录');
                    window.location.href = '/';
                    return;
                }

                const createResult = await createResponse.json();

                if (createResult.code !== '200') {
                    throw new Error(`创建关卡失败: ${createResult.message}`);
                }

                // 2. 创建分享记录
                const puzzleId = createResult.data.puzzle_id;
                console.log('puzzleId:', puzzleId, 'type:', typeof puzzleId);
                const shareResponse = await fetch('/share/shares', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${token}`
                    },
                    body: JSON.stringify({
                        puzzle_id: puzzleId,
                    })
                });

                // 再次检查401错误
                if (shareResponse.status === 401) {
                    localStorage.removeItem('puzzleToken');
                    localStorage.removeItem('userId');
                    alert('登录已过期，请重新登录');
                    window.location.href = '/';
                    return;
                }

                // 处理所有非200响应
                if (!shareResponse.ok) {
                    const errorText = await shareResponse.text();
                    throw new Error(`服务器错误: ${shareResponse.status} - ${errorText}`);
                }

                    // 处理成功响应
                    const shareResult = await shareResponse.json();
                    if (shareResult.code === '200') {
                        handleShareSuccess(shareResult.data);
                    } else {
                        throw new Error(`分享失败: ${shareResult.message}`);
                    }

            } catch (error) {
                console.error('分享失败:', error);
                alert(`分享失败: ${error.message}`);
            }
        }
    </script>


<!-- 帮助页面模态框 -->
<div class="modal-mask" id="helpModal" style="display: none;">
    <div class="modal-content" style="max-width: 500px;">
        <div class="modal-header">
            <span>操作指南</span>
            <span class="modal-close" onclick="document.getElementById('helpModal').style.display='none'">×</span>
        </div>
        <div class="modal-body" style="font-size: 14px; line-height: 24px; color: #E0E0E0;">
            <p><strong style="color: #F9E078;">1. 游戏操作</strong></p>
            <p>- 鼠标左键长按图块，拖拽到拼图区域</p>
            <p>- 单击选中的图块，顺时针旋转90度</p>
            <p>- 点击"撤销"可还原上一步操作，"重做"恢复撤销操作</p>
            <p><strong style="color: #F9E078; margin-top: 16px; display: block;">2. 自定义拼图</strong></p>
            <p>- 支持上传本地图片（JPG/PNG，最大5MB），可裁剪调整</p>
            <p>- 可设置拼图块数（4-64块）、形状（矩形/异形）、是否旋转</p>
            <p><strong style="color: #F9E078; margin-top: 16px; display: block;">3. 存档与分享</strong></p>
            <p>- 登录用户存档同步至服务器，游客存档仅保存在当前浏览器</p>
            <p>- 自定义拼图可分享至"分享中心"，供其他玩家游玩</p>
        </div>
        <div class="modal-footer">
            <button class="btn btn-primary" onclick="document.getElementById('helpModal').style.display='none'">我知道了</button>
        </div>
    </div>
</div>

    <!-- 页面特定的背景音乐 -->
    <script>
        // 等待音乐管理器加载完成
        function initPageMusic() {
            if (window.musicManager) {
                // 拼图编辑器页面自动播放主界面音乐
                window.musicManager.playScene('main');
            } else {
                // 如果音乐管理器尚未加载，稍后重试
                setTimeout(initPageMusic, 100);
            }
        }
        
        // 页面加载完成后直接初始化音乐，无需等待用户交互
        document.addEventListener('DOMContentLoaded', function() {
            // 直接尝试播放音乐
            initPageMusic();
        });
    </script>

<script>
// 移动端设备检测和类添加
(function() {
    'use strict';
    
    function isMobile() {
        return /Android|webOS|iPhone|iPad|iPod|BlackBerry|IEMobile|Opera Mini/i.test(navigator.userAgent) ||
               window.innerWidth <= 768;
    }
    
    function addMobileClass() {
        if (isMobile()) {
            document.body.classList.add('mobile-device');
        }
    }
    
    // 页面加载完成后初始化
    if (document.readyState === 'loading') {
        document.addEventListener('DOMContentLoaded', addMobileClass);
    } else {
        addMobileClass();
    }
    
    // 窗口大小改变时重新检测
    window.addEventListener('resize', function() {
        setTimeout(addMobileClass, 100);
    });
})();
</script>

    </body>
</html>

