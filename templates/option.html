<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
    <meta name="format-detection" content="telephone=no">
    <meta name="format-detection" content="email=no">
    <meta name="format-detection" content="address=no">
    <meta name="mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <meta name="theme-color" content="#20223A">
    <title>拼图大师 - 选择关卡</title>
    <link rel="stylesheet" href="{{ url_for('static', filename='css/style.css') }}">
    <link rel="stylesheet" href="{{ url_for('static', filename='css/mobile.css') }}">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/font-awesome@4.7.0/css/font-awesome.min.css">
</head>
<body>
{% include '_navbar.html' %}
<div class="container" style="max-width: 1200px; margin: 0 auto;">
    <div class="background-blur"></div>
    <div class="page-title" style="margin-top: 20px;">
        <button class="btn btn-secondary back-btn" onclick="window.location.href='{{ url_for('main') }}';" style="padding: 8px 16px; font-size: 12px; margin-right: 16px;">
            <span class="chinese-text">返回</span>
        </button>
        <span class="chinese-text" style="color: #F9E078; font-size: 18px;">选择关卡</span>
    </div>

    <div class="filter-area card" style="margin-bottom: 24px; background-color:#20223A;">
        <div style="display: flex; flex-wrap: wrap; gap: 20px;">
            <div style="flex: 1; min-width: 200px;">
                <label class="filter-section-label">风格筛选</label>
                <div style="display: flex; flex-wrap: wrap; gap: 10px;">
                    <label class="filter-label active" data-filter="style" data-value="all" style="padding: 8px 16px; border-radius: 0; cursor: pointer; background-color: #F9E078; color: #20223A; border: 2px solid #F9E078; box-shadow: 3px 3px 0 #000000; font-family: 'Press Start 2P', 'Zpix', monospace; font-size: 12px; transition: all 0.1s ease;">全部</label>
                    <label class="filter-label" data-filter="style" data-value="nature" style="padding: 8px 16px; border-radius: 0; cursor: pointer; border: 2px solid #F9E078; background: #20223A; color: #F9E078; box-shadow: 3px 3px 0 #000000; font-family: 'Press Start 2P', 'Zpix', monospace; font-size: 12px; transition: all 0.1s ease;">自然风光</label>
                    <label class="filter-label" data-filter="style" data-value="animal" style="padding: 8px 16px; border-radius: 0; cursor: pointer; border: 2px solid #F9E078; background: #20223A; color: #F9E078; box-shadow: 3px 3px 0 #000000; font-family: 'Press Start 2P', 'Zpix', monospace; font-size: 12px; transition: all 0.1s ease;">动物</label>
                    <label class="filter-label" data-filter="style" data-value="building" style="padding: 8px 16px; border-radius: 0; cursor: pointer; border: 2px solid #F9E078; background: #20223A; color: #F9E078; box-shadow: 3px 3px 0 #000000; font-family: 'Press Start 2P', 'Zpix', monospace; font-size: 12px; transition: all 0.1s ease;">建筑</label>
                    <label class="filter-label" data-filter="style" data-value="cartoon" style="padding: 8px 16px; border-radius: 0; cursor: pointer; border: 2px solid #F9E078; background: #20223A; color: #F9E078; box-shadow: 3px 3px 0 #000000; font-family: 'Press Start 2P', 'Zpix', monospace; font-size: 12px; transition: all 0.1s ease;">卡通</label>
                    <label class="filter-label" data-filter="style" data-value="other" style="padding: 8px 16px; border-radius: 0; cursor: pointer; border: 2px solid #F9E078; background: #20223A; color: #F9E078; box-shadow: 3px 3px 0 #000000; font-family: 'Press Start 2P', 'Zpix', monospace; font-size: 12px; transition: all 0.1s ease;">其他</label>
                </div>
            </div>
            <div style="flex: 1; min-width: 200px;">
                <label class="filter-section-label">难度筛选</label>
                <div style="display: flex; flex-wrap: wrap; gap: 10px;">
                    <label class="filter-label active" data-filter="difficulty" data-value="all" style="padding: 8px 16px; border-radius: 0; cursor: pointer; background-color: #F9E078; color: #20223A; border: 2px solid #F9E078; box-shadow: 3px 3px 0 #000000; font-family: 'Press Start 2P', 'Zpix', monospace; font-size: 12px; transition: all 0.1s ease;">全部</label>
                    <label class="filter-label" data-filter="difficulty" data-value="easy" style="padding: 8px 16px; border-radius: 0; cursor: pointer; border: 2px solid #F9E078; background: #20223A; color: #F9E078; box-shadow: 3px 3px 0 #000000; font-family: 'Press Start 2P', 'Zpix', monospace; font-size: 12px; transition: all 0.1s ease;">简单</label>
                    <label class="filter-label" data-filter="difficulty" data-value="medium" style="padding: 8px 16px; border-radius: 0; cursor: pointer; border: 2px solid #F9E078; background: #20223A; color: #F9E078; box-shadow: 3px 3px 0 #000000; font-family: 'Press Start 2P', 'Zpix', monospace; font-size: 12px; transition: all 0.1s ease;">中等</label>
                    <label class="filter-label" data-filter="difficulty" data-value="hard" style="padding: 8px 16px; border-radius: 0; cursor: pointer; border: 2px solid #F9E078; background: #20223A; color: #F9E078; box-shadow: 3px 3px 0 #000000; font-family: 'Press Start 2P', 'Zpix', monospace; font-size: 12px; transition: all 0.1s ease;">困难</label>
                    <label class="filter-label" data-filter="difficulty" data-value="extreme" style="padding: 8px 16px; border-radius: 0; cursor: pointer; border: 2px solid #F9E078; background: #20223A; color: #F9E078; box-shadow: 3px 3px 0 #000000; font-family: 'Press Start 2P', 'Zpix', monospace; font-size: 12px; transition: all 0.1s ease;">极难</label>
                </div>
            </div>
        </div>
    </div>

    <div class="level-list" id="levelList" style="display: grid; grid-template-columns: repeat(auto-fill, minmax(200px, 1fr)); gap: 20px; margin-bottom: 80px;"></div>

    <!-- 固定底部按钮区域 -->
    <div id="fixedGameBtn" style="position: fixed; bottom: 0; left: 0; right: 0; background-color: #20223A; border-top: 2px solid #F9E078; padding: 15px; text-align: center; z-index: 1000; display: none;">
        <button id="enterGameBtn" class="btn btn-primary" style="padding: 12px 40px; font-size: 14px; margin-right: 20px;" disabled>
            <span class="chinese-text">进入游戏</span>
        </button>
        <button id="levelRankingBtn" class="btn btn-secondary" style="padding: 12px 40px; font-size: 14px;" disabled>
            <span class="chinese-text">本关排名</span>
        </button>
    </div>
</div>

<!-- 帮助页面模态框 -->
<div class="modal-mask" id="helpModal" style="display: none;">
    <div class="modal-content" style="max-width: 500px;">
        <div class="modal-header">
            <span>操作指南</span>
            <span class="modal-close" onclick="document.getElementById('helpModal').style.display='none'">×</span>
        </div>
        <div class="modal-body" style="font-size: 14px; line-height: 24px; color: #E0E0E0;">
            <!-- 桌面端操作指南 -->
            <div id="desktop-help" style="display: none;">
                <p><strong style="color: #F9E078;">1. 游戏操作</strong></p>
                <p>- 鼠标左键长按图块，拖拽到拼图区域</p>
                <p>- 单击选中的图块，顺时针旋转90度</p>
                <p>- 点击"撤销"可还原上一步操作，"重做"恢复撤销操作</p>
                <p><strong style="color: #F9E078; margin-top: 16px; display: block;">2. 自定义拼图</strong></p>
                <p>- 支持上传本地图片（JPG/PNG，最大5MB），可裁剪调整</p>
                <p>- 可设置拼图块数（4-64块）、形状（矩形/异形）、是否旋转</p>
                <p><strong style="color: #F9E078; margin-top: 16px; display: block;">3. 存档与分享</strong></p>
                <p>- 登录用户存档同步至服务器，游客存档仅保存在当前浏览器</p>
                <p>- 自定义拼图可分享至"分享中心"，供其他玩家游玩</p>
            </div>
            
            <!-- 移动端操作指南 -->
            <div id="mobile-help" style="display: none;">
                <p><strong style="color: #F9E078;">📱 移动端关卡选择</strong></p>
                <p><strong style="color: #F9E078;">1. 浏览关卡</strong></p>
                <p>- 上下滑动浏览不同风格的拼图</p>
                <p>- 点击关卡卡片查看大图预览</p>
                <p>- 支持自然风光、动物、建筑、卡通等风格</p>
                <p><strong style="color: #F9E078; margin-top: 16px; display: block;">2. 难度选择</strong></p>
                <p>- 简单：适合新手，基础拼图</p>
                <p>- 中等：经典难度，需要一定技巧</p>
                <p>- 困难：高难度挑战，考验耐心</p>
                <p>- 极难：极限挑战，专家级别</p>
                <p><strong style="color: #F9E078; margin-top: 16px; display: block;">3. 筛选功能</strong></p>
                <p>- 点击筛选标签快速找到想要的关卡</p>
                <p>- 可以同时使用风格和难度筛选</p>
                <p><strong style="color: #F9E078; margin-top: 16px; display: block;">4. 开始游戏</strong></p>
                <p>- 选择喜欢的关卡后点击底部"进入游戏"</p>
                <p>- 系统会自动跳转到游戏界面</p>
            </div>
        </div>
        <div class="modal-footer">
            <button class="btn btn-primary" onclick="document.getElementById('helpModal').style.display='none'">我知道了</button>
        </div>
    </div>
</div>

<script>
let selectedLevelId = '';
let selectedImage = '';
let selectedDifficulty = 3;
let currentStyleFilter = 'all';
let currentDifficultyFilter = 'all';

// 数据库难度/展示映射
const diffColorMap = { easy: '#52C41A', medium: '#FAAD14', hard: '#FF4D4F', extreme: '#8B0000' };
const diffTextMap = { easy: '简单', medium: '中等', hard: '困难', extreme: '极难' };

// 根据编辑器中的难度判断逻辑计算难度评分
function calculateDifficultyScore(totalPieces, pieceShape, isRotatable, isFlipable) {
    const gridSize = Math.sqrt(totalPieces); // 计算网格尺寸
    let score = 0;
    
    // 网格尺寸评分（3/4/5/6/8）
    if (gridSize <= 3) score += 1;       // 3×3 = 9块
    else if (gridSize === 4) score += 2; // 4×4 = 16块
    else if (gridSize === 5) score += 3; // 5×5 = 25块
    else if (gridSize === 6) score += 4; // 6×6 = 36块
    else if (gridSize >= 8) score += 5;  // 8×8 = 64块

    // 形状评分：rect(方形)最易，triangle 次之，irregular(拼图块/不规则)最难
    if (pieceShape === 'triangle') score += 1;
    else if (pieceShape === 'irregular') score += 2;

    // 旋转/翻转增加难度
    if (isRotatable) score += 1;
    if (isFlipable) score += 1;
    
    return score;
}

// 根据评分获取难度等级
function getDifficultyByScore(score) {
    if (score <= 2) return 'easy';
    if (score <= 4) return 'medium';
    if (score <= 6) return 'hard';
    return 'extreme';
}

// 从数据库渲染关卡
function renderLevels(levels){
    const list = document.getElementById('levelList');
    list.innerHTML = '';
    if(!levels || !levels.length){
        list.innerHTML = '<div style="grid-column:1/-1; text-align:center; color:#B8BCC8; padding:20px;">暂无系统关卡</div>' +
                         '<div style="grid-column:1/-1; text-align:center; padding:8px;">' +
                         '<a href="' + ("{{ url_for('editor_page') }}") + '" class="btn btn-primary">去创建拼图</a>' +
                         '</div>';
        return;
    }
    levels.forEach(item => {
        const type = (item.type||'other');
        
        // 数据库中的piece_count存储的是总块数（如64表示8×8）
        const totalPieces = parseInt(item.piece_count) || 16;
        const gridSize = Math.sqrt(totalPieces); // 计算网格尺寸
        const gridVal = Math.floor(gridSize); // 一边数用于传递给游戏
        const pieceShape = item.piece_shape || 'rect';
        const isRotatable = Boolean(item.is_rotatable);
        const isFlipable = Boolean(item.is_flipable);
        
        const difficultyScore = calculateDifficultyScore(totalPieces, pieceShape, isRotatable, isFlipable);
        const calculatedDifficulty = getDifficultyByScore(difficultyScore);
        const diffColor = diffColorMap[calculatedDifficulty] || '#52C41A';
        const diffText = diffTextMap[calculatedDifficulty] || '简单';
        const card = document.createElement('div');
        card.className = 'level-card card';
        card.setAttribute('data-style', type);
        card.setAttribute('data-difficulty', calculatedDifficulty);
        card.style.cssText = 'cursor:pointer; position:relative; background-color:#20223A;';
        card.onclick = (e) => selectLevel(item.puzzle_id || item.level_id || item.title, item.image_url, gridVal);
        const typeText = type === 'nature' ? '自然风光' : type === 'animal' ? '动物' : type === 'building' ? '建筑' : type === 'cartoon' ? '卡通' : '其他';
        card.innerHTML = `
            <div style="position: relative; margin-bottom: 12px;">
                <img src="${item.image_url}" alt="${item.title||''}" style="width: 100%; height: 140px; object-fit: cover; border-radius: 4px;">
                <span style="position: absolute; top: 8px; left: 8px; background-color: ${diffColor}; color: #FFF; font-size: 12px; padding: 2px 8px; border-radius: 4px;">${diffText}</span>
            </div>
            <h3 style="font-size: 16px; margin-bottom: 8px;">${item.title||''} - ${diffText}</h3>
            <div style="font-size: 12px; color: #B8BCC8;">${Math.floor(gridSize)} x ${Math.floor(gridSize)} (${totalPieces}块) - ${typeText}</div>
        `;
        list.appendChild(card);
    });
    applyFilters();
}

async function loadSystemLevels(){
    try{
        const r = await fetch('/pic/levels/system');
        const j = await r.json();
        if(j && j.code === 200){
            renderLevels(j.data || []);
        }else{
            document.getElementById('levelList').innerHTML = '<div style="grid-column:1/-1; text-align:center; color:#FF4D4F; padding:20px;">加载失败</div>';
        }
    }catch(e){
        document.getElementById('levelList').innerHTML = '<div style="grid-column:1/-1; text-align:center; color:#FF4D4F; padding:20px;">网络错误</div>';
    }
}

// 筛选功能
function applyFilters() {
    const levelCards = document.querySelectorAll('.level-card');
    levelCards.forEach(card => {
        const cardStyle = card.getAttribute('data-style');
        const cardDifficulty = card.getAttribute('data-difficulty');
        let showCard = true;
        if (currentStyleFilter !== 'all' && cardStyle !== currentStyleFilter) showCard = false;
        if (currentDifficultyFilter !== 'all' && cardDifficulty !== currentDifficultyFilter) showCard = false;
        card.style.display = showCard ? 'block' : 'none';
    });
}

// 筛选按钮点击事件
document.querySelectorAll('.filter-label').forEach(label => {
    label.addEventListener('click', () => {
        const filterType = label.getAttribute('data-filter');
        const filterValue = label.getAttribute('data-value');
        const parent = label.parentElement;
        parent.querySelectorAll('.filter-label').forEach(btn => {
            btn.classList.remove('active');
            btn.style.backgroundColor = '#20223A';
            btn.style.color = '#F9E078';
        });
        label.classList.add('active');
        label.style.backgroundColor = '#F9E078';
        label.style.color = '#20223A';
        if (filterType === 'style') currentStyleFilter = filterValue;
        else if (filterType === 'difficulty') currentDifficultyFilter = filterValue;
        applyFilters();
    });
});

// 选择关卡
function selectLevel(id, image, difficulty) {
    selectedLevelId = id;
    selectedImage = image;
    selectedDifficulty = difficulty;
    document.querySelectorAll('.level-card').forEach(card => { card.style.border = '1px solid #E5E7EB'; });
    event.currentTarget.style.border = '2px solid #F9E078';
    document.getElementById('fixedGameBtn').style.display = 'block';
    document.getElementById('enterGameBtn').disabled = false;
    document.getElementById('levelRankingBtn').disabled = false;
}

// 查看关卡排名
document.getElementById('levelRankingBtn').addEventListener('click', () => {
    if (!selectedLevelId) { // 防错：确保已选择关卡
        alert('请先选择一个关卡');
        return;
    }
    console.log('选择的关卡ID:', selectedLevelId);
    // 1. 保留localStorage备份（可选，用于排名界面二次验证）
    localStorage.setItem('selectedLevelForRanking', selectedLevelId);
    // 2. 关键：在URL中携带levelId参数（排名界面将通过这个参数获取当前关卡）
    const rankUrl = '{{ url_for('level_rank_page') }}?levelId=' + selectedLevelId;
    window.location.href = rankUrl; // 跳转带参数的排名页面
});

// 进入游戏
document.getElementById('enterGameBtn').addEventListener('click', () => {
    // 记录当前关卡ID（用于保存/恢复进度接口）
    if (selectedLevelId) {
        localStorage.setItem('puzzleId', String(selectedLevelId));
        localStorage.setItem('isSystemLevel', 'true');
    }
    localStorage.setItem('customImage', selectedImage);
    localStorage.setItem('customSize', selectedDifficulty);
    window.location.href = '{{ url_for('game_page') }}';
});

// 页面加载
document.addEventListener('DOMContentLoaded', function() {
    loadSystemLevels();
    loadUserLevelRecords();
    // 根据设备类型显示对应的帮助内容
    if (isMobile()) {
        document.getElementById('mobile-help').style.display = 'block';
    } else {
        document.getElementById('desktop-help').style.display = 'block';
    }
});

// 加载用户关卡记录（保持原有逻辑以展示最佳成绩等）
function loadUserLevelRecords() {
    const token = localStorage.getItem('puzzleToken');
    if (!token) return;
    fetch('/levels/records', {
        method: 'GET',
        headers: { 'Authorization': `Bearer ${token}`, 'Content-Type': 'application/json' }
    })
    .then(response => response.json())
    .then(data => {
        if (data.code === 200) updateLevelCards(data.data);
    })
    .catch(() => {});
}

// 更新关卡卡片显示（保留原有最佳成绩渲染）
function updateLevelCards(records) {
    const levelCards = document.querySelectorAll('.level-card');
    levelCards.forEach(card => {
        const titleEl = card.querySelector('h3');
        const levelId = titleEl ? (titleEl.textContent||'').split(' - ')[0] : '';
        const record = records.find(r => r.level_id === levelId);
        if (record) {
            let statusElement = card.querySelector('div[style*="font-size: 12px;"]');
            if (statusElement) statusElement.textContent = record.status_text || '已挑战';
        }
    });
}
</script>
<!-- 页面特定的背景音乐 -->
<script>
    function initPageMusic() {
        if (window.musicManager) {
            window.musicManager.playScene('main');
        } else {
            setTimeout(initPageMusic, 100);
        }
    }
    document.addEventListener('DOMContentLoaded', function() {
        initPageMusic();
    });
</script>

<script>
// 移动端设备检测和类添加
(function() {
    'use strict';
    
    function isMobile() {
        return /Android|webOS|iPhone|iPad|iPod|BlackBerry|IEMobile|Opera Mini/i.test(navigator.userAgent) ||
               window.innerWidth <= 768;
    }
    
    function addMobileClass() {
        if (isMobile()) {
            document.body.classList.add('mobile-device');
        }
    }
    
    // 页面加载完成后初始化
    if (document.readyState === 'loading') {
        document.addEventListener('DOMContentLoaded', addMobileClass);
    } else {
        addMobileClass();
    }
    
    // 窗口大小改变时重新检测
    window.addEventListener('resize', function() {
        setTimeout(addMobileClass, 100);
    });
})();
</script>

</body>
</html>