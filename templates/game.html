<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
    <meta name="format-detection" content="telephone=no">
    <meta name="format-detection" content="email=no">
    <meta name="format-detection" content="address=no">
    <meta name="mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <meta name="theme-color" content="#20223A">
    <title>拼图游戏</title>
    <link rel="stylesheet" href="{{ url_for('static', filename='css/game-rank.css') }}">
    <link rel="stylesheet" href="{{ url_for('static', filename='css/mobile.css') }}">
</head>
<body>
{% include '_navbar.html' %}
<div class="background-blur"></div>
<div class="container">
    <h1>拼图游戏</h1>
    <div class="controls">
        <button id="toggleBgBtn" class="btn">隐藏背景</button>
        <button id="undoBtn" class="btn">撤销</button>
        <button id="restartBtn" class="btn">重新开始</button>
        <button id="saveBtn" class="btn">保存进度</button>
        <button id="restoreBtn" class="btn">恢复进度</button>
    </div>
    
    <div class="game-info">
        <div id="timer">时间: 00:00</div>
        <div id="moves">移动次数: 0</div>

    </div>
    <div class="puzzle-container">
        <div class="puzzle-board-wrapper"> <!-- 新增一个 wrapper -->
                <div id="puzzleBg" class="puzzle-bg"></div>
                <div id="puzzleBoard" class="puzzle-board"></div>
            </div>
        <div id="piecesZone" class="pieces-zone"></div>
    </div>
    <div id="gameComplete" class="game-complete">
        <div class="message">
            <h2>恭喜！拼图完成！</h2>
            <p id="completeInfo"></p>
            <button id="playAgainBtn" class="btn">再玩一次</button>
        </div>
    </div>
</div>

<!-- 帮助页面模态框 -->
<div class="modal-mask" id="helpModal" style="display: none;">
    <div class="modal-content" style="max-width: 500px;">
        <div class="modal-header">
            <span>操作指南</span>
            <span class="modal-close" onclick="closeHelpModal()">×</span>
        </div>
        <div class="modal-body" style="font-size: 14px; line-height: 24px; color: #E0E0E0;">
            <!-- 桌面端操作指南 -->
            <div id="desktop-help" style="display: none;">
                <p><strong style="color: #F9E078;">1. 游戏操作</strong></p>
                <p>- 鼠标左键长按图块，拖拽到拼图区域</p>
                <p>- 单击选中的图块，顺时针旋转90度</p>
                <p>- 点击"撤销"可还原上一步操作，"重做"恢复撤销操作</p>
                <p><strong style="color: #F9E078; margin-top: 16px; display: block;">2. 自定义拼图</strong></p>
                <p>- 支持上传本地图片（JPG/PNG，最大5MB），可裁剪调整</p>
                <p>- 可设置拼图块数（4-64块）、形状（矩形/异形）、是否旋转</p>
                <p><strong style="color: #F9E078; margin-top: 16px; display: block;">3. 存档与分享</strong></p>
                <p>- 登录用户存档同步至服务器，游客存档仅保存在当前浏览器</p>
                <p>- 自定义拼图可分享至"分享中心"，供其他玩家游玩</p>
            </div>
            
            <!-- 移动端操作指南 -->
            <div id="mobile-help" style="display: none;">
                <p><strong style="color: #F9E078;">📱 移动端操作指南</strong></p>
                <p><strong style="color: #F9E078;">1. 拼图块操作</strong></p>
                <p>- <strong>长按拖拽</strong>：长按拼图块开始拖拽到棋盘</p>
                <p>- <strong>单击选中</strong>：单击拼图块显示选中效果</p>
                <p>- <strong>双击旋转</strong>：双击拼图块顺时针旋转90度</p>
                <p>- <strong>三击翻转</strong>：三击拼图块水平翻转</p>
                <p><strong style="color: #F9E078; margin-top: 16px; display: block;">2. 拼图块栏</strong></p>
                <p>- 所有拼图块以多行形式显示，无需滚动</p>
                <p>- 拼图块自动居中对齐，间距适中</p>
                <p><strong style="color: #F9E078; margin-top: 16px; display: block;">3. 游戏控制</strong></p>
                <p>- 点击"撤销"可还原上一步操作</p>
                <p>- 点击"保存进度"保存当前游戏状态</p>
                <p>- 点击"恢复进度"恢复之前保存的游戏</p>
                <p><strong style="color: #F9E078; margin-top: 16px; display: block;">4. 游戏技巧</strong></p>
                <p>- 先拼边框，再拼内部细节</p>
                <p>- 利用颜色和图案特征快速定位</p>
                <p>- 可以随时保存进度，下次继续</p>
            </div>
        </div>
        <div class="modal-footer">
            <button class="btn btn-primary" onclick="closeHelpModal()">我知道了</button>
        </div>
    </div>
</div>
    <svg width="0" height="0" style="position: absolute; z-index: -1;">
      <defs id="puzzle-defs"></defs>
    </svg>
<script src="{{ url_for('static', filename='js/script.js') }}"></script>
<script>
    document.addEventListener('DOMContentLoaded', function() {
        const restoreBtn = document.getElementById('restoreBtn');
        if (restoreBtn) {
            restoreBtn.addEventListener('click', restoreProgressFromDB);
        }
    });
    document.getElementById('saveBtn').addEventListener('click', async function() {
        // 假设你有这些变量
    const piecesOnBoard = Array.from(document.querySelectorAll('#puzzleBoard .puzzle-piece')).map(piece => {
        const obj = {
            correctX: piece.dataset.correctX,
            correctY: piece.dataset.correctY,
            currentX: piece.dataset.currentX,
            currentY: piece.dataset.currentY,
            rotation: piece.dataset.rotation,
            flipped: piece.dataset.flipped
        };
        // 三角形拼图保存 type
        if (shape === 'triangle' && piece.dataset.type) {
            obj.type = piece.dataset.type;
        }
        // jigsaw 拼图保存四边信息
        if (shape === 'jigsaw') {
            obj.edgeTop = piece.dataset.edgeTop;
            obj.edgeRight = piece.dataset.edgeRight;
            obj.edgeBottom = piece.dataset.edgeBottom;
            obj.edgeLeft = piece.dataset.edgeLeft;
        }
        return obj;
    });

        // 读取上下文：token 与 puzzleId（用于进度保存/恢复）
        const token = localStorage.getItem('puzzleToken');
        const puzzle_id = localStorage.getItem('puzzleId') || 1; 
        

        // 获取已用时和已总步数
        const used_time = typeof seconds !== 'undefined' ? seconds : 0;
        const total_steps = typeof moves !== 'undefined' ? moves : 0;
        console.log(used_time);
        console.log(total_steps);
        if (!token) {
            alert('请先登录！');
            return;
        }
        // 发起保存请求
        const res = await fetch('/pic/save_progress', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
                'Authorization': 'Bearer ' + token
            },
            body: JSON.stringify({
                puzzle_id,
                progress_json: JSON.stringify(piecesOnBoard),
                used_time,
                total_steps
            })
        });

        const data = await res.json();
        alert('进度已保存！');
        console.log('保存结果', data);
    });
// 游戏暂停/继续功能
let gamePaused = false;
let gameInstance = null;

// 等待游戏实例初始化
document.addEventListener('DOMContentLoaded', function() {
    // 延迟获取游戏实例，确保game.js已经加载
    setTimeout(() => {
        if (window.puzzleGame) {
            gameInstance = window.puzzleGame;
        }
    }, 100);
});

// 打开帮助模态框时暂停游戏
function openHelpModal() {
    const helpModal = document.getElementById('helpModal');
    if (helpModal) {
        helpModal.style.display = 'flex';
        
        // 根据设备类型显示相应的帮助内容
        const isMobile = /Android|webOS|iPhone|iPad|iPod|BlackBerry|IEMobile|Opera Mini/i.test(navigator.userAgent) || window.innerWidth <= 768;
        const desktopHelp = document.getElementById('desktop-help');
        const mobileHelp = document.getElementById('mobile-help');
        
        if (isMobile) {
            desktopHelp.style.display = 'none';
            mobileHelp.style.display = 'block';
        } else {
            desktopHelp.style.display = 'block';
            mobileHelp.style.display = 'none';
        }
        
        // 暂停游戏
        if (gameInstance && gameInstance.gameStarted && !gamePaused) {
            gameInstance.pauseGame();
            gamePaused = true;
        }
    }
}

// 关闭帮助模态框时继续游戏
function closeHelpModal() {
    const helpModal = document.getElementById('helpModal');
    if (helpModal) {
        helpModal.style.display = 'none';
        
        // 继续游戏
        if (gameInstance && gamePaused) {
            gameInstance.resumeGame();
            gamePaused = false;
        }
    }
}

// 重写导航栏的帮助按钮点击事件（仅限game页面）
document.addEventListener('DOMContentLoaded', function() {
    const helpLink = document.getElementById('pm-help-link');
    if (helpLink) {
        // 移除原有的事件监听器
        helpLink.onclick = null;
        // 添加新的事件监听器
        helpLink.addEventListener('click', function(e) {
            e.preventDefault();
            e.stopPropagation();
            openHelpModal();
        });
    }
    const piecesZone = document.getElementById('piecesZone');
    if (piecesZone) {
        piecesZone.addEventListener('wheel', function(event) {
            const hasHorizontalScrollbar = piecesZone.scrollWidth > piecesZone.clientWidth;

            if (hasHorizontalScrollbar) {
                event.preventDefault();

                let scrollAmount = event.deltaY;
                if (scrollAmount === 0 && event.deltaX !== 0) {
                    scrollAmount = event.deltaX;
                }

                piecesZone.scrollLeft += scrollAmount;
            }

        }, { passive: false });
    }
});
</script>
    <!-- 页面特定的背景音乐 -->
    <script>
        // 等待音乐管理器加载完成
        function initPageMusic() {
            if (window.musicManager) {
                // 游戏界面自动播放游戏音乐
                window.musicManager.playScene('game');
            } else {
                // 如果音乐管理器尚未加载，稍后重试
                setTimeout(initPageMusic, 100);
            }
        }
        
        // 页面加载完成后直接初始化音乐，无需等待用户交互
        document.addEventListener('DOMContentLoaded', function() {
            // 直接尝试播放音乐
            initPageMusic();
        });

        document.addEventListener('DOMContentLoaded', function() {
    if (localStorage.getItem('fromMyPuzzle') === '1') {
        localStorage.removeItem('fromMyPuzzle'); // 用完即删，避免影响下次
        if (typeof restoreProgressFromDB === 'function') {
            restoreProgressFromDB();
        } else {
            setTimeout(() => {
                if (typeof restoreProgressFromDB === 'function') restoreProgressFromDB();
            }, 300);
        }
    }
});
    </script>
    
    <!-- 移动端支持脚本 -->
    <script src="{{ url_for('static', filename='js/mobile-support.js') }}"></script>
</body>
</html>