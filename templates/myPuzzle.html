<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <title>我的拼图</title>
    <link rel="stylesheet" href="{{ url_for('static', filename='css/style.css') }}">
</head>
<body>
{% include '_navbar.html' %}
<div class="container" style="max-width: 900px; margin: 0 auto;">
    <h2 style="color:#F9E078;margin:24px 0;">我的拼图存档</h2>
    <!-- 筛选区 -->
    <div style="margin-bottom: 20px; display: flex; gap: 20px;">
        <div>
            <label>状态：</label>
            <select id="statusFilter">
                <option value="all">全部</option>
                <option value="playing">进行中</option>
                <option value="completed">已完成</option>
            </select>
        </div>
        <div>
            <label>难度：</label>
            <select id="difficultyFilter">
                <option value="all">全部</option>
                <option value="3">简单（3s×d）</option>
                <option value="4">中等（4×4）</option>
                <option value="5">困难（5×5）</option>
            </select>
        </div>
        <button class="btn btn-danger" onclick="clearAllSaves()" style="margin-left:auto;">清理全部存档</button>
    </div>
    <div id="puzzleList" style="display: grid; grid-template-columns: repeat(auto-fill, minmax(220px, 1fr)); gap: 20px;"></div>
    <div id="emptyState" style="text-align:center; color:#B8BCC8; display:none; margin:40px 0;">暂无游戏存档</div>
</div>
<script>
let allRecords = [];

document.addEventListener('DOMContentLoaded', function() {
    loadMyPuzzleRecords();
    document.getElementById('statusFilter').addEventListener('change', applyFilters);
    document.getElementById('difficultyFilter').addEventListener('change', applyFilters);
});

function loadMyPuzzleRecords() {
    const token = localStorage.getItem('puzzleToken');
    fetch('/pic/get_my_progress', {
        headers: { 'Authorization': 'Bearer ' + token }
    })
    .then(res => res.json())
    .then(data => {
        const list = document.getElementById('puzzleList');
        const emptyState = document.getElementById('emptyState');
        list.innerHTML = '';
        allRecords = (data.data && Array.isArray(data.data)) ? data.data : [];
        if (!allRecords.length) {
            list.style.display = 'none';
            emptyState.style.display = 'block';
            return;
        }
        emptyState.style.display = 'none';
        list.style.display = 'grid';
        applyFilters();
    });
}

function applyFilters() {
    const status = document.getElementById('statusFilter').value;
    const difficulty = document.getElementById('difficultyFilter').value;
    const list = document.getElementById('puzzleList');
    list.innerHTML = '';
    let filtered = allRecords.filter(item => {
        let statusOk = (status === 'all') || (item.status === status);
        let diffOk = (difficulty === 'all') || (String(item.difficulty) === difficulty);
        return statusOk && diffOk;
    });
    if (!filtered.length) {
        list.style.display = 'none';
        document.getElementById('emptyState').style.display = 'block';
        return;
    }
    document.getElementById('emptyState').style.display = 'none';
    list.style.display = 'grid';
    filtered.forEach(item => {
        const card = document.createElement('div');
        card.className = 'puzzle-card card';
        card.style.cssText = 'background:#20223A;padding:16px;border-radius:8px;position:relative;';
        card.innerHTML = `
            <img src="${item.image_url}" alt="${item.title}" style="width:100%;height:120px;object-fit:cover;border-radius:4px;">
            <h3 style="color:#F9E078;font-size:16px;margin:10px 0 6px;">${item.title || ''}</h3>
            <div style="font-size:13px;color:#B8BCC8;">
        难度：${(parseInt(Math.sqrt(item.piece_count)) + '*' + parseInt(Math.sqrt(item.piece_count)))}<br>                保存时间：${item.updated_at ? item.updated_at.split('T')[0] : ''}<br>
                已用时：${formatTime(item.used_time)}<br>
                已走步数：${item.total_steps || 0} 步<br>
                状态：${item.status_text || (item.status === 'completed' ? '已完成' : '进行中')}
            </div>
            <button class="btn btn-primary" style="margin-top:10px;width:48%;" 
    onclick="continueGame('${item.puzzle_id}', '${item.image_url}', '${item.piece_count}')">继续游戏</button>
            <button class="btn btn-danger" style="margin-top:10px;width:48%;float:right;" onclick="deleteSave('${item.puzzle_id}')">删除</button>
        `;
        list.appendChild(card);
    });
}

function formatTime(seconds) {
    if (!seconds) return '00:00';
    const m = Math.floor(seconds / 60).toString().padStart(2, '0');
    const s = (seconds % 60).toString().padStart(2, '0');
    return `${m}:${s}`;
}

function continueGame(puzzleId, imageUrl, difficulty) {
    localStorage.setItem('puzzleId', puzzleId);
    // 如果你有 imageUrl 和 difficulty，也可以一并存储
    if (imageUrl) localStorage.setItem('customImage', imageUrl);
        if (difficulty) {
        const diff = Math.sqrt(Number(difficulty));
        localStorage.setItem('customSize', diff);
    }
    localStorage.setItem('fromMyPuzzle', '1'); // 标记来源
    window.location.href = '{{ url_for('game_page') }}';
}

function deleteSave(puzzleId) {
    if (!confirm('确定要删除这个存档吗？')) return;
    const token = localStorage.getItem('puzzleToken');
    fetch(`/pic/delete_progress?puzzle_id=${puzzleId}`, {
        method: 'DELETE',
        headers: { 'Authorization': 'Bearer ' + token }
    })
    .then(res => res.json())
    .then(data => {
        if (data.code === 200) {
            alert('删除成功');
            loadMyPuzzleRecords();
        } else {
            alert('删除失败');
        }
    });
}

function clearAllSaves() {
    if (!confirm('确定要清理全部存档吗？')) return;
    const token = localStorage.getItem('puzzleToken');
    fetch('/pic/delete_all_progress', {
        method: 'DELETE',
        headers: { 'Authorization': 'Bearer ' + token }
    })
    .then(res => res.json())
    .then(data => {
        if (data.code === 200) {
            alert('全部存档已清理');
            loadMyPuzzleRecords();
        } else {
            alert('清理失败');
        }
    });
}
</script>
</body>
</html>